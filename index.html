<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>å†°é›ªå¥‡ç·£ç´™å¨ƒå¨ƒ - æ™ºèƒ½åˆ†é¡å¹³æ¿ç‰ˆ ğŸ‘‘â„ï¸</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700&family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
<script src="https://unpkg.com/@phosphor-icons/web"></script>

<style>
    :root {
        --primary: #9b51e0;
        --secondary: #ff69b4;
        --bg-gradient: linear-gradient(135deg, #e0c3fc 0%, #8ec5fc 100%);
        --glass-bg: rgba(255, 255, 255, 0.75);
        --glass-border: rgba(255, 255, 255, 0.5);
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

    body {
        margin: 0; font-family: 'Nunito', 'Noto Sans TC', sans-serif;
        background: var(--bg-gradient); height: 100vh; width: 100vw; overflow: hidden;
    }

    /* ğŸŒŸ æ ¸å¿ƒæ”¹å‹• 1ï¼šå°‡åŸæœ¬çš„ä¸Šä¸‹ä½ˆå±€æ”¹ç‚ºå·¦å³æ»¿ç‰ˆä½ˆå±€ */
    .app-container {
        display: flex; flex-direction: row; width: 100%; height: 100%;
        overflow: hidden;
    }

    /* --- å·¦å´ 2/3ï¼šå¤§ç‰ˆé¢å±•ç¤ºå€ --- */
    #left-panel {
        flex: 2; /* ä½”æ“š 2/3 å¯¬åº¦ */
        display: flex; justify-content: center; align-items: center;
        position: relative; overflow: hidden; padding: 20px;
    }

    #doll-area {
        position: relative; 
        /* è®“ç•«å¸ƒåœ¨å¹³æ¿ä¸Šç›¡å¯èƒ½æ”¾å¤§ï¼Œç¶­æŒ 5:7 æ¯”ä¾‹ */
        height: 95%; max-height: none; aspect-ratio: 5 / 7; 
        background-color: white; background-size: cover; background-position: center; 
        border-radius: 24px; box-shadow: inset 0 0 20px rgba(0,0,0,0.1), 0 20px 40px rgba(0,0,0,0.2);
        transition: background-image 0.8s ease-in-out; overflow: hidden;
    }

    #doll {
        position: absolute; left: 0; top: 0; width: 100%; height: 100%;
    }

    .equip-layer {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        object-fit: contain; pointer-events: none; transition: opacity 0.3s ease;
    }

    /* --- å³å´ 1/3ï¼šæ•´åˆåŠŸèƒ½åˆ—èˆ‡è¡£æ«ƒ --- */
    #right-panel {
        flex: 1; /* ä½”æ“š 1/3 å¯¬åº¦ */
        background: var(--glass-bg);
        border-left: 2px solid var(--glass-border);
        display: flex; flex-direction: column; padding: 20px;
        box-shadow: -5px 0 25px rgba(0,0,0,0.05);
        z-index: 100; overflow-y: auto;
    }

    .controls-row {
        display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 15px;
    }

    .btn-action {
        flex: 1; min-width: 80px;
        padding: 10px 15px; font-size: 16px; font-weight: bold;
        border: none; border-radius: 12px; cursor: pointer; transition: all 0.2s;
        display: flex; justify-content: center; align-items: center; gap: 6px;
        background: linear-gradient(45deg, var(--primary), var(--secondary));
        color: white; box-shadow: 0 2px 10px rgba(155, 81, 224, 0.2);
    }
    .btn-action:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(155, 81, 224, 0.4); }
    .btn-danger { background: white; color: #ff4d4f; border: 2px solid #ff4d4f; box-shadow: none; }
    .btn-danger:hover { background: #fff1f0; }
    .btn-photo { background: linear-gradient(45deg, #00d2ff, #3a7bd5); width: 100%; flex: none; margin-bottom: 5px; font-size: 18px; padding: 12px;}

    .category-filters { 
        display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 15px; 
        padding-bottom: 15px; border-bottom: 2px dashed rgba(0,0,0,0.1);
    }

    .filter-btn {
        flex: 1 1 calc(33.333% - 8px); /* ä¸€æ’ä¸‰å€‹ */
        background: white; border: 2px solid #bae6fd; border-radius: 12px;
        padding: 8px 5px; font-size: 15px; font-weight: bold; color: #0284c7;
        cursor: pointer; transition: all 0.2s; text-align: center;
    }
    .filter-btn.active, .filter-btn:hover { background: #0284c7; color: white; border-color: #0284c7; }

    /* ğŸŒŸ æ ¸å¿ƒæ”¹å‹• 2ï¼šå³å´è¡£æ«ƒæ”¹ç‚ºå‚ç›´ç¶²æ ¼æ»¾å‹• */
    #items {
        display: grid; 
        grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); 
        gap: 15px; align-content: start;
        flex: 1; overflow-y: auto; padding: 5px; margin-bottom: 20px;
    }
    #items::-webkit-scrollbar { width: 6px; }
    #items::-webkit-scrollbar-track { background: rgba(255,255,255,0.3); border-radius: 4px; }
    #items::-webkit-scrollbar-thumb { background: var(--secondary); border-radius: 4px; }

    .item {
        width: 100%; aspect-ratio: 1 / 1; cursor: pointer; 
        background: #e0f2fe; border: 3px solid transparent; border-radius: 16px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1); object-fit: contain; 
        transition: all 0.2s ease;
    }
    .item:hover { transform: translateY(-3px) scale(1.05); border-color: var(--secondary); box-shadow: 0 8px 12px rgba(255, 105, 180, 0.3); }
    .item.equipped { border-color: #ff69b4; background: #fce7f3; box-shadow: 0 0 15px rgba(255, 105, 180, 0.5); }

    /* --- æ–°å¢ï¼šèƒŒæ™¯æ§åˆ¶å€ --- */
    .bg-controls {
        background: rgba(255,255,255,0.8); border-radius: 16px; padding: 15px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.05);
    }
    .bg-controls-title { font-weight: bold; color: #4a5568; margin-bottom: 10px; display: flex; align-items: center; gap: 5px; }
    .bg-btn-row { display: flex; gap: 10px; margin-bottom: 10px; }
    .bg-btn { 
        flex: 1; padding: 10px; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; 
        background: #f1f5f9; color: #475569; transition: 0.2s;
    }
    .bg-btn:hover { background: #e2e8f0; }
    .bg-btn-auto { width: 100%; background: #8b5cf6; color: white; padding: 12px; border-radius: 10px; font-weight: bold; border: none; cursor: pointer; transition: 0.2s;}
    .bg-btn-auto.paused { background: #cbd5e1; color: #475569; }

    #loading-overlay {
        position: absolute; top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(5px);
        display: flex; flex-direction: column; justify-content: center; align-items: center;
        z-index: 100; opacity: 0; pointer-events: none; transition: opacity 0.3s;
        font-size: 24px; font-weight: bold; color: var(--primary);
    }
</style>
</head>
<body>

<div class="app-container">
    <!-- å·¦å´ä¸»è§’å€ (2/3) -->
    <div id="left-panel">
        <div id="doll-area">
            <div id="doll">
                <img id="layer-friend" class="equip-layer" style="z-index: 5;">
                <img id="layer-base" class="equip-layer" style="z-index: 10;">
                <img id="layer-shoes" class="equip-layer" style="z-index: 20;">
                <img id="layer-clothes" class="equip-layer" style="z-index: 30;">
                <img id="layer-necklace" class="equip-layer" style="z-index: 40;">
                <img id="layer-earrings" class="equip-layer" style="z-index: 45;">
                <img id="layer-hair" class="equip-layer" style="z-index: 50;">
                <img id="layer-headwear" class="equip-layer" style="z-index: 60;">
                <img id="layer-handheld" class="equip-layer" style="z-index: 70;">
            </div>
            
            <div id="loading-overlay">
                <i class="ph ph-camera" style="font-size: 64px; margin-bottom: 15px;"></i>
                é­”æ³•ç›¸æ©Ÿæ²–å°ä¸­...
            </div>
        </div>
    </div>

    <!-- å³å´æ“ä½œå€ (1/3) -->
    <div id="right-panel">
        <div class="controls-row">
            <button onclick="takePhoto()" class="btn-action btn-photo">
                <i class="ph-fill ph-camera"></i> é­”æ³•æ‹ç…§
            </button>
            <button onclick="switchCharacter()" class="btn-action">
                <i class="ph ph-arrows-left-right"></i> æ›ä¸»è§’
            </button>
            <button onclick="clearAllAccessories()" class="btn-action btn-danger">
                <i class="ph ph-trash"></i> å¸ä¸‹å…¨éƒ¨
            </button>
        </div>
        
        <div class="category-filters" id="filters">
            <button class="filter-btn active" data-filter="all">å…¨éƒ¨</button>
            <button class="filter-btn" data-filter="headwear">A é ­é£¾</button>
            <button class="filter-btn" data-filter="hair">H é ­é«®</button>
            <button class="filter-btn" data-filter="earrings">E è€³ç’°</button>
            <button class="filter-btn" data-filter="necklace">N é …éŠ</button>
            <button class="filter-btn" data-filter="clothes">C è¡£æœ</button>
            <button class="filter-btn" data-filter="handheld">W æ‰‹æŒ</button>
            <button class="filter-btn" data-filter="shoes">S é‹å­</button>
            <button class="filter-btn" data-filter="friend">F æœ‹å‹</button>
        </div>

        <div id="items"></div>

        <!-- èƒŒæ™¯æ§åˆ¶å„€è¡¨æ¿ -->
        <div class="bg-controls">
            <div class="bg-controls-title"><i class="ph-fill ph-image"></i> å ´æ™¯èƒŒæ™¯æ§åˆ¶</div>
            <div class="bg-btn-row">
                <button onclick="manualChangeBg(-1)" class="bg-btn"><i class="ph ph-caret-left"></i> ä¸Šä¸€å¼µ</button>
                <button onclick="manualChangeBg(1)" class="bg-btn">ä¸‹ä¸€å¼µ <i class="ph ph-caret-right"></i></button>
            </div>
            <button onclick="toggleAutoBg()" id="btn-autobg" class="bg-btn-auto">
                ğŸŸ¢ è‡ªå‹•è¼ªæ’­ï¼šé–‹å•Ÿä¸­
            </button>
        </div>
    </div>
</div>

<script>
// ==========================================
// 1. æ™ºèƒ½æª”åè‡ªå‹•æ¢æ¸¬ç³»çµ± (ä¿ç•™åŸå§‹å¼·å¤§åŠŸèƒ½)
// ==========================================
const wardrobe = document.getElementById('items');

const categoriesToLoad = [
    { prefix: 'A', type: 'headwear' },
    { prefix: 'H', type: 'hair' },
    { prefix: 'E', type: 'earrings' },
    { prefix: 'N', type: 'necklace' },
    { prefix: 'C', type: 'clothes' },
    { prefix: 'W', type: 'handheld' },
    { prefix: 'S', type: 'shoes' },
    { prefix: 'F', type: 'friend' }
];

function autoLoadAccessories() {
    wardrobe.innerHTML = ''; 
    const excludeFiles = ['anna-base.jpg', 'elsa-base.jpg', 'anna-base.png', 'elsa-base.png'];
    
    categoriesToLoad.forEach(cat => {
        let currentIndex = 1; 
        
        function tryLoadNext() {
            const paddedIndex = String(currentIndex).padStart(2, '0');
            
            const possibleNames = [
                `${cat.prefix}${paddedIndex}.png`,       
                `${cat.prefix}${paddedIndex}.jpg`,       
                `${cat.prefix}${paddedIndex}.PNG`,       
                `${cat.prefix}${paddedIndex}.JPG`,       
                `${cat.prefix.toLowerCase()}${paddedIndex}.png`, 
                `${cat.prefix.toLowerCase()}${paddedIndex}.jpg`  
            ];
            
            let currentNameIndex = 0;

            function testNextName() {
                if (currentNameIndex >= possibleNames.length) return; 
                
                const testSrc = possibleNames[currentNameIndex];
                
                if (excludeFiles.includes(testSrc.toLowerCase())) {
                    currentNameIndex++;
                    testNextName();
                    return;
                }
                
                const tempImg = new Image();
                
                tempImg.onload = () => {
                    const img = document.createElement('img');
                    img.className = 'item';
                    img.dataset.category = cat.type; 
                    img.src = testSrc;
                    
                    // é»æ“Šäº‹ä»¶ç¶å®š
                    img.onclick = () => { equipItem(testSrc, cat.type, img); };
                    
                    wardrobe.appendChild(img);
                    currentIndex++;
                    tryLoadNext(); 
                };
                
                tempImg.onerror = () => {
                    currentNameIndex++;
                    testNextName();
                };
                
                tempImg.src = testSrc; 
            }
            testNextName(); 
        }
        tryLoadNext();
    });
}

// ==========================================
// 2. æ ¸å¿ƒæ›è£é‚è¼¯ (ğŸŒŸ æ ¸å¿ƒæ”¹å‹• 3ï¼šåŠ å…¥ Toggle é–‹é—œé‚è¼¯)
// ==========================================
const allCategories = ['shoes', 'clothes', 'necklace', 'earrings', 'hair', 'headwear', 'handheld', 'friend'];

function equipItem(src, category, imgElement) {
    const layer = document.getElementById(`layer-${category}`);
    if (layer) {
        // å–å¾—ç•¶å‰åœ–å±¤çš„åœ–ç‰‡æª”åï¼Œç”¨ä¾†åˆ¤æ–·æ˜¯å¦å·²ç¶“ç©¿æˆ´
        const currentSrc = layer.getAttribute('src');
        
        // å¦‚æœç›®å‰ç©¿æˆ´çš„å°±æ˜¯é»æ“Šçš„é€™ä»¶ï¼Œå‰‡ã€Œå¸ä¸‹ã€ (Toggle é—œé–‰)
        if (currentSrc === src) {
            layer.src = '';
            layer.style.opacity = '0';
            imgElement.classList.remove('equipped');
        } else {
            // å¦å‰‡ã€Œç©¿ä¸Šã€æˆ–ã€Œæ›ä¸€ä»¶ã€ (Toggle é–‹å•Ÿ)
            layer.src = src; 
            layer.style.opacity = '0';
            setTimeout(() => layer.style.opacity = '1', 50);
            
            // æ¸…é™¤è©²åˆ†é¡å…¶ä»–æŒ‰éˆ•çš„é«˜äº®ç‹€æ…‹ï¼Œä¸¦æŠŠç•¶å‰é»æ“Šçš„é«˜äº®
            document.querySelectorAll(`.item[data-category="${category}"]`).forEach(el => el.classList.remove('equipped'));
            imgElement.classList.add('equipped');
        }
    }
}

function clearAllAccessories() {
    allCategories.forEach(cat => {
        const layer = document.getElementById(`layer-${cat}`);
        if(layer) {
            layer.src = ''; 
            layer.style.opacity = '0';
        }
    });
    // æ¸…é™¤è¡£æ«ƒæ‰€æœ‰é«˜äº®ç‹€æ…‹
    document.querySelectorAll('.item').forEach(el => el.classList.remove('equipped'));
}

// ==========================================
// 3. åˆå§‹åŒ–åŸºåº•èˆ‡ç¯©é¸å™¨
// ==========================================
let currentCharacter = 'elsa';

function setBaseImage(char) {
    const baseImg = document.getElementById('layer-base');
    const targetSrc = char === 'elsa' ? 'elsa-base.png' : 'anna-base.png';
    baseImg.src = targetSrc;
    
    baseImg.onerror = () => {
        const bgColor = char === 'elsa' ? '%2300d2ff' : '%239b51e0';
        baseImg.src = `data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='420' height='620'><rect width='420' height='620' fill='${bgColor}'/><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' fill='white' font-size='24' font-family='sans-serif'>æ‰¾ä¸åˆ° ${targetSrc}</text></svg>`;
    };
}

function switchCharacter() {
    currentCharacter = currentCharacter === 'elsa' ? 'anna' : 'elsa';
    setBaseImage(currentCharacter);
    clearAllAccessories(); 
}

// åˆ†é¡ç¯©é¸å™¨ç¶å®š
document.querySelectorAll('.filter-btn').forEach(btn => {
    btn.onclick = (e) => {
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        e.target.classList.add('active');
        
        const targetCategory = e.target.dataset.filter;
        const allItems = document.querySelectorAll('.item');
        
        allItems.forEach(item => {
            if (targetCategory === 'all' || item.dataset.category === targetCategory) {
                item.style.display = 'block';
            } else {
                item.style.display = 'none';
            }
        });
    }
});

// ==========================================
// 4. èƒŒæ™¯æ‰‹å‹•/è‡ªå‹•è¼ªæ’­æ§åˆ¶ç³»çµ± (ğŸŒŸ æ ¸å¿ƒæ”¹å‹• 4)
// ==========================================
const bgList = ['bg1.jpg', 'bg2.jpg', 'bg3.jpg', 'bg4.jpg', 'bg5.jpg'];
let currentBgIndex = 0;
let isAutoBg = true;
let autoTimer = null;
const dollArea = document.getElementById('doll-area');

// æ¸²æŸ“ç•¶å‰èƒŒæ™¯
function applyBg() {
    const bgUrl = bgList[currentBgIndex];
    const tempImg = new Image();
    tempImg.src = bgUrl;
    tempImg.onload = () => { dollArea.style.backgroundImage = `url(${bgUrl})`; };
    tempImg.onerror = () => { dollArea.style.backgroundColor = '#e0f7fa'; };
}

// å•Ÿå‹•è¨ˆæ™‚å™¨ (30ç§’æ›ä¸€æ¬¡ï¼Œä¾ç…§æ‚¨åŸæœ¬çš„è¨­å®š)
function startAutoTimer() {
    if (autoTimer) clearInterval(autoTimer);
    if (isAutoBg) {
        autoTimer = setInterval(() => {
            currentBgIndex = (currentBgIndex + 1) % bgList.length;
            applyBg();
        }, 30000); 
    }
}

// æ‰‹å‹•åˆ‡æ› (ä¸Š/ä¸‹ä¸€å¼µ)
function manualChangeBg(direction) {
    currentBgIndex = (currentBgIndex + direction + bgList.length) % bgList.length;
    applyBg();
    
    // æ‰‹å‹•åˆ‡æ›å¾Œé‡ç½®è¨ˆæ™‚å™¨ï¼Œé¿å…é¦¬ä¸Šåˆè¢«è‡ªå‹•åˆ‡æ›
    if (isAutoBg) startAutoTimer();
}

// é–‹é—œè‡ªå‹•åˆ‡æ›åŠŸèƒ½
function toggleAutoBg() {
    isAutoBg = !isAutoBg;
    const btn = document.getElementById('btn-autobg');
    if (isAutoBg) {
        btn.innerHTML = 'ğŸŸ¢ è‡ªå‹•è¼ªæ’­ï¼šé–‹å•Ÿä¸­';
        btn.classList.remove('paused');
        startAutoTimer();
    } else {
        btn.innerHTML = 'âšª è‡ªå‹•è¼ªæ’­ï¼šå·²æš«åœ';
        btn.classList.add('paused');
        clearInterval(autoTimer);
    }
}

// ==========================================
// 5. é­”æ³•ç›¸æ©Ÿ (ä¿ç•™æ‚¨çš„ç„¡æ®˜å½±ã€é˜²å¡æ­»åŸç‰ˆç¨‹å¼ç¢¼)
// ==========================================
function takePhoto() {
    const targetArea = document.getElementById('doll-area');
    const overlay = document.getElementById('loading-overlay');
    overlay.style.opacity = '1'; 
    
    setTimeout(() => {
        html2canvas(targetArea, {
            useCORS: true, 
            allowTaint: true, 
            backgroundColor: null, 
            scale: 2,
            ignoreElements: (element) => element.id === 'loading-overlay' 
        }).then(canvas => {
            const link = document.createElement('a');
            link.download = `é­”æ³•å°å…¬ä¸»_${new Date().getTime()}.png`;
            link.href = canvas.toDataURL('image/png');
            link.click();
        }).catch(err => {
            console.error('æˆªåœ–éŒ¯èª¤ï¼š', err);
            alert('é­”æ³•ç›¸æ©Ÿé‡åˆ°äº†ä¸€é»é˜»ç¤™ï¼ˆå¯èƒ½éœ€è¦å°‡ç¶²é ç™¼å¸ƒè‡³ GitHub Pages å¾Œæ‰èƒ½æ­£å¸¸æˆªåœ–å–”ï¼‰ï¼');
        }).finally(() => {
            overlay.style.opacity = '0';
        });
    }, 400); 
}

// ==========================================
// ç¶²é è¼‰å…¥æ™‚å•Ÿå‹•
// ==========================================
window.onload = () => { 
    setBaseImage('elsa'); 
    autoLoadAccessories(); 
    applyBg(); // åˆå§‹èƒŒæ™¯
    startAutoTimer(); // å•Ÿå‹•èƒŒæ™¯è¨ˆæ™‚
};
</script>
</body>
</html>