<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>é­”æ³•é…ä»¶å°é½Šæ ¡æ­£å™¨ ğŸ“âœ¨</title>
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700&family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
<script src="https://unpkg.com/@phosphor-icons/web"></script>
<style>
    :root {
        --primary: #9b51e0;
        --secondary: #ff69b4;
        --bg: #f3e8ff;
    }
    body {
        font-family: 'Nunito', 'Noto Sans TC', sans-serif; background: var(--bg);
        display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; padding: 20px; color: #333;
    }
    .container {
        background: white; padding: 30px; border-radius: 20px;
        box-shadow: 0 10px 30px rgba(155, 81, 224, 0.2); max-width: 900px; width: 100%;
        display: flex; gap: 30px; align-items: flex-start;
    }
    .panel { flex: 1; display: flex; flex-direction: column; gap: 15px; }
    
    h1 { color: var(--primary); margin-top: 0; display: flex; align-items: center; gap: 10px; font-size: 24px; }
    
    .upload-box {
        background: #f8f9fa; border: 2px dashed var(--primary); padding: 15px;
        border-radius: 12px; cursor: pointer; text-align: center; transition: all 0.2s;
    }
    .upload-box:hover { background: #f3e8ff; }
    input[type="file"] { display: none; }
    
    .preview-container {
        width: 420px; height: 620px; border: 2px solid #ddd; border-radius: 16px;
        background: repeating-conic-gradient(#eee 0% 25%, transparent 0% 50%) 50% / 20px 20px;
        position: relative; overflow: hidden; cursor: grab; box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    .preview-container:active { cursor: grabbing; }
    
    canvas { display: block; }

    .instructions {
        background: #e0f2fe; color: #0284c7; padding: 15px; border-radius: 12px; font-size: 14px; line-height: 1.6;
    }

    .slider-group { display: flex; flex-direction: column; gap: 5px; }
    input[type="range"] { accent-color: var(--secondary); }

    button {
        background: linear-gradient(45deg, var(--primary), var(--secondary)); color: white;
        border: none; padding: 15px; font-size: 16px; font-weight: bold; border-radius: 12px;
        cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; transition: transform 0.2s;
    }
    button:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(155, 81, 224, 0.3); }
</style>
</head>
<body>

<div class="container">
    <!-- å·¦å´ï¼šç•«å¸ƒé è¦½å€ -->
    <div class="preview-container" id="canvas-wrapper">
        <canvas id="canvas" width="420" height="620"></canvas>
    </div>

    <!-- å³å´ï¼šæ§åˆ¶é¢æ¿ -->
    <div class="panel">
        <h1><i class="ph-fill ph-magic-wand"></i> é…ä»¶å°é½Šæ ¡æ­£å™¨</h1>
        
        <div class="instructions">
            <b>æ“ä½œæ­¥é©Ÿï¼š</b><br>
            1. è¼‰å…¥åŸºåº•åœ– (ç•¶ä½œåŠé€æ˜åƒè€ƒ)ã€‚<br>
            2. è¼‰å…¥é…ä»¶åœ– (æœƒè‡ªå‹•å»é™¤ç´”è‰²èƒŒæ™¯)ã€‚<br>
            3. åœ¨å·¦å´ç•«å¸ƒ<b>æ‹–æ›³ç§»å‹•</b>ã€ä½¿ç”¨æ»‘é¼ <b>æ»¾è¼ªç¸®æ”¾</b>ï¼Œå°‡è¡£æœå°æº–åŸºåº•ã€‚<br>
            4. é»æ“ŠåŒ¯å‡ºï¼Œå³å¯å¾—åˆ°å®Œç¾ 1:1 çš„é€æ˜ PNGï¼
        </div>

        <label class="upload-box">
            <i class="ph ph-user" style="font-size: 24px; color: var(--primary);"></i>
            <div style="font-weight: bold; color: var(--primary);">1. è¼‰å…¥åŸºåº•åœ– (å¦‚ elsa-base.jpg)</div>
            <input type="file" id="baseInput" accept="image/*">
        </label>

        <label class="upload-box">
            <i class="ph ph-t-shirt" style="font-size: 24px; color: var(--secondary);"></i>
            <div style="font-weight: bold; color: var(--secondary);">2. è¼‰å…¥é…ä»¶åœ– (å¦‚ item1.jpg)</div>
            <input type="file" id="itemInput" accept="image/*">
        </label>

        <div class="slider-group">
            <label>ğŸ” æ‰‹å‹•å¾®èª¿ç¸®æ”¾æ¯”ä¾‹ï¼š</label>
            <input type="range" id="scaleSlider" min="0.1" max="3" step="0.01" value="1">
        </div>

        <button id="downloadBtn"><i class="ph-fill ph-download-simple"></i> åŒ¯å‡ºå®Œç¾å°é½Šé…ä»¶</button>
    </div>
</div>

<script>
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d', { willReadFrequently: true });
    const baseInput = document.getElementById('baseInput');
    const itemInput = document.getElementById('itemInput');
    const scaleSlider = document.getElementById('scaleSlider');
    const downloadBtn = document.getElementById('downloadBtn');
    const wrapper = document.getElementById('canvas-wrapper');

    let baseImg = new Image();
    let itemImg = new Image();
    let processedItemImg = new Image(); // å­˜æ”¾å»èƒŒå¾Œçš„é…ä»¶

    // ğŸŒŸ æ–°å¢ï¼šç”¨ä¾†è¨˜ä½æ‚¨ä¸Šå‚³çš„åŸå§‹æª”å
    let originalItemFilename = 'aligned_item.png';

    // é…ä»¶çš„ç‹€æ…‹ (ä½ç½®èˆ‡ç¸®æ”¾)
    let itemX = 100;
    let itemY = 100;
    let itemScale = 1;

    // æ‹–æ›³æ§åˆ¶
    let isDragging = false;
    let startX, startY;

    // --- ç¹ªè£½ç•«å¸ƒ ---
    function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // 1. ç•«åŸºåº•åœ– (åŠé€æ˜åƒè€ƒç”¨)
        if (baseImg.src) {
            ctx.globalAlpha = 0.4; // åŠé€æ˜
            ctx.drawImage(baseImg, 0, 0, canvas.width, canvas.height);
            ctx.globalAlpha = 1.0;
        }

        // 2. ç•«é…ä»¶åœ–
        if (processedItemImg.src) {
            const w = processedItemImg.width * itemScale;
            const h = processedItemImg.height * itemScale;
            ctx.drawImage(processedItemImg, itemX, itemY, w, h);
        }
    }

    // --- è‡ªå‹•å»èƒŒè™•ç† ---
    function removeBackground(sourceImage, callback) {
        const tempCanvas = document.createElement('canvas');
        const tempCtx = tempCanvas.getContext('2d', { willReadFrequently: true });
        tempCanvas.width = sourceImage.width;
        tempCanvas.height = sourceImage.height;
        tempCtx.drawImage(sourceImage, 0, 0);

        try {
            const imageData = tempCtx.getImageData(0, 0, tempCanvas.width, tempCanvas.height);
            const data = imageData.data;
            const bgR = data[0], bgG = data[1], bgB = data[2], bgA = data[3];
            
            if (bgA > 0) {
                for (let i = 0; i < data.length; i += 4) {
                    const r = data[i], g = data[i+1], b = data[i+2];
                    const distance = Math.sqrt((r-bgR)**2 + (g-bgG)**2 + (b-bgB)**2);
                    if (distance <= 45) data[i+3] = 0; 
                }
                tempCtx.putImageData(imageData, 0, 0);
            }
            callback(tempCanvas.toDataURL('image/png'));
        } catch (e) {
            callback(sourceImage.src);
        }
    }

    // --- è¼‰å…¥åœ–ç‰‡äº‹ä»¶ ---
    baseInput.addEventListener('change', (e) => {
        if (!e.target.files[0]) return;
        baseImg.src = URL.createObjectURL(e.target.files[0]);
        baseImg.onload = draw;
    });

    itemInput.addEventListener('change', (e) => {
        if (!e.target.files[0]) return;
        
        // ğŸŒŸ é­”æ³•é—œéµï¼šåœ¨ä¸Šå‚³çš„ç¬é–“ï¼ŒæŠŠæª”åï¼ˆå«å‰¯æª”åï¼‰è¨˜ä¸‹ä¾†ï¼
        originalItemFilename = e.target.files[0].name;
        
        itemImg.src = URL.createObjectURL(e.target.files[0]);
        itemImg.onload = () => {
            // è¼‰å…¥å¾Œå…ˆè‡ªå‹•å»èƒŒ
            removeBackground(itemImg, (dataUrl) => {
                processedItemImg.src = dataUrl;
                processedItemImg.onload = () => {
                    // å°‡é…ä»¶é‡ç½®åˆ°ç•«é¢ä¸­é–“
                    itemScale = 1;
                    scaleSlider.value = 1;
                    itemX = (canvas.width - processedItemImg.width) / 2;
                    itemY = (canvas.height - processedItemImg.height) / 2;
                    draw();
                };
            });
        };
    });

    // --- æ‹–æ›³èˆ‡ç¸®æ”¾äº’å‹• ---
    wrapper.addEventListener('mousedown', (e) => {
        isDragging = true;
        startX = e.clientX - itemX;
        startY = e.clientY - itemY;
    });

    window.addEventListener('mousemove', (e) => {
        if (isDragging) {
            itemX = e.clientX - startX;
            itemY = e.clientY - startY;
            draw();
        }
    });

    window.addEventListener('mouseup', () => { isDragging = false; });

    // æ»¾è¼ªç¸®æ”¾
    wrapper.addEventListener('wheel', (e) => {
        e.preventDefault();
        const scaleAmount = -e.deltaY * 0.001;
        itemScale = Math.max(0.1, Math.min(itemScale + scaleAmount, 3));
        scaleSlider.value = itemScale;
        draw();
    });

    // æ»‘æ¡¿ç¸®æ”¾
    scaleSlider.addEventListener('input', (e) => {
        itemScale = parseFloat(e.target.value);
        draw();
    });

    // --- åŒ¯å‡ºåŠŸèƒ½ ---
    downloadBtn.addEventListener('click', () => {
        if (!processedItemImg.src) {
            alert("è«‹å…ˆè¼‰å…¥é…ä»¶åœ–ç‰‡å–”ï¼");
            return;
        }

        // å»ºç«‹ä¸€å€‹ä¹¾æ·¨çš„ç•«å¸ƒï¼Œã€åªç•«é…ä»¶ï¼Œä¸ç•«åŸºåº•åœ–ã€‘
        const exportCanvas = document.createElement('canvas');
        exportCanvas.width = 420;
        exportCanvas.height = 620;
        const exportCtx = exportCanvas.getContext('2d');

        const w = processedItemImg.width * itemScale;
        const h = processedItemImg.height * itemScale;
        exportCtx.drawImage(processedItemImg, itemX, itemY, w, h);

        const link = document.createElement('a');
        // åŒ¯å‡ºæ™‚ç›´æ¥å¥—ç”¨æ‚¨åŸæœ¬çš„æª”å
        link.download = originalItemFilename;
        link.href = exportCanvas.toDataURL('image/png');
        link.click();

        // ğŸŒŸ æ–°å¢ï¼šä¸‹è¼‰å®Œæˆå¾Œï¼Œè‡ªå‹•æ¸…é™¤é…ä»¶ï¼Œä¿ç•™åŸºåº•åœ–ï¼Œè¿æ¥ä¸‹ä¸€ä»¶è¡£æœï¼
        setTimeout(() => {
            processedItemImg.removeAttribute('src'); // å¾¹åº•æ¸…é™¤å»èƒŒå¾Œçš„åœ–ç‰‡è³‡æ–™
            itemImg.removeAttribute('src');          // å¾¹åº•æ¸…é™¤åŸå§‹åœ–ç‰‡è³‡æ–™
            itemInput.value = '';                    // æ¸…ç©ºä¸Šå‚³æ¬„ä½ (é€™æ¨£æ‰èƒ½é‡è¤‡ä¸Šå‚³åŒåæª”æ¡ˆ)
            originalItemFilename = 'aligned_item.png'; // é‡ç½®æª”åè®Šæ•¸
            draw(); // é‡æ–°ç¹ªè£½ç•«å¸ƒï¼ˆæ­¤æ™‚å› ç‚ºæ²’æœ‰é…ä»¶äº†ï¼Œç•«å¸ƒä¸Šåªæœƒç•«å‡ºåŸºåº•åœ–ï¼‰
        }, 100); // ç¨å¾®å»¶é² 0.1 ç§’ï¼Œç¢ºä¿ç€è¦½å™¨å·²ç¶“æˆåŠŸè§¸ç™¼ä¸‹è¼‰å‹•ä½œ
    });
</script>

</body>
</html>